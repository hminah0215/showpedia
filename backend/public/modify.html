<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>회원정보 수정/삭제</title>
</head>

<body>

  <table>

    <tr>
      <td>아이디</td>
      <td><input type="text" name="" id="memberId"></td>
    </tr>

    <tr>
      <td>암호</td>
      <td><input type="password" name="" id="pwd"></td>
    </tr>

    <tr>
      <td>닉네임</td>
      <td><input type="text" name="" id="nickName"></td>
    </tr>

    <tr>
      <td>프로필이미지</td>
      <td>
        <input type="file" name="profilePhoto" id="profilePhoto">
        <span id="uploadFilePath"></span>
      </td>
    </tr>

    <tr>
      <td colspan="2">
        <button id="btnSave" onclick="fnSave();">수정</button>
        <button id="btnDelete">삭제</button>
      </td>
    </tr>

  </table>

  <input type="hidden" id="memberId"></input>
  <input type="hidden" name="" id="changeFilePath" />

  <!--Jquery 라이브러리 참조-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <!-- 개발자 정의 클라이언트 스크립트 코드 -->
  <script>

    // url에서 쿼리스트링 키의 값을 추출해서 반환 
    function urlParam(id) {
      var results = new RegExp('[\?&]' + id + '=([^&#]*)').exec(window.location.href);
      if (results == null) {
        return null;
      }
      else {
        return results[1] || 0;
      }
    }


    $(document).ready(function () {

      // 현재 페이지 url에서 id 값을 추출한다. 
      var memberId = urlParam("id");

      // 백엔드 단일 게시글 정보 조회 
      $.get("http://localhost:3005/modify/" + memberId, function (res) {
    
        console.log("회원정보 조회내용: ", res.data);

        if (res.code == "200" || res.msg == "OK") {
          //
          $("#memberId").val(res.data.memberId);
          //$("#userpwd").val(res.data.userpwd); 기존의 암호는 굳이 보여줄 필요가 없음 
          $("#nickName").val(res.data.nickName);

          // uploadFilePath 라는 span 태그에 저장된 파일명 텍스트를 보여준다.
          $("#uploadFilePath").text(res.data.profilePhoto);
          //
        } else {
          alert("회원정보수정 API 호출 에러발생 : ", res.msg);
        }

      });

    });

    // 데이터 수정 함수 
    function fnSave() {

      // 백엔드 주소로 보낼 json데이터를 만든다.
      let member = {
        "memberId": $("#memberId").val(),
        
        "pwd": $("#pwd").val(),
        "nickName": $("#nickName").val(),
        
        // hidden 값으로 전달된 파일 저장경로를 보낸다 
        "profilePhoto": $("#changeFilePath").val(),

      }

      // 백엔드 주소로 데이터를 보내 수정 처리한다.
      $.ajax({
        url: "http://localhost:3005/modify",
        type: "post", // 메소드 타입
        data: member,
        success: function (res) {

          // console.log(res);

          if (res.msg == "OK") {
            alert("회원정보수정 완료!");
           // location.href = "./list.html";

          } else {
            alert("회원정보수정 에러발생", res.msg);
          }

        }
      });

    }
          // 첨부파일이 선택되거나 변경되면 실행되는 이벤트
          $("#profilePhoto").change(function () {
            // alert("파일 선택 변경됨");
      
            // multer는 form 태그에서 사용이 가능한데, 폼 데이터로 전송해도 사용이 가능하다. 
            // FormData 객체를 사용! 폼데이터를 생성하고 해당 폼 데이터내에 파일 데이터정보를 추가한다. 
            // 해당 폼 데이터를 post 방식으로 백엔드 api에 전송한다.
            var data = new FormData();
            data.append("profilePhoto", $("input[name=profilePhoto]")[0].files[0]);
      
            $.ajax({
              data: data,
              type: "post",
              url: "http://localhost:3005/uploads",
              contentType: false,
              processData: false,
              success: function (res) {
                console.log("업로드된 파일의 경로정보: ", res);
      
                // input 히든 필드에 담아놓는다.
                $('#changeFilePath').val(res.filepath);
              }
            })
          })


    // 삭제 실행 
    $("#btnDelete").click(function () {

      if (confirm("회원정보를 삭제하시겠습니까?")) {

        var memberId = urlParam("id");

        $.ajax({
          url: "http://localhost:3005/delete/" + memberId,
          type: "delete",
          success: function (res) {

            console.log("삭제데이터 건수: ", res);

            if (res.data == 1) {
              alert("회원정보 삭제완료!");
              location.href = "./list.html";
            } else {
              console.error("회원삭제 에러발생");
            }
          }
        })// 삭제 ajax 끝부분

      }
    })



  </script>

</body>

</html>