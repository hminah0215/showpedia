<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>회원등록</title>
  </head>

  <body>
    <table>
      <tr>
        <td>아이디</td>
        <td><input type="text" name="memberId" id="memberId" /></td>
      </tr>

      <tr>
        <td>암호</td>
        <td><input type="password" name="pwd" id="pwd" /></td>
      </tr>

      <tr>
        <td>닉네임</td>
        <td><input type="text" name="nickName" id="nickName" /></td>
      </tr>

      <tr>
        <td>프로필이미지</td>
        <td>
          <input type="file" name="profilePhoto" id="profilePhoto" />
        </td>
      </tr>

      <tr>
        <td colspan="2"><button id="btnSave" onclick="fnSave();">등록</button></td>
      </tr>
    </table>

    <input type="hidden" name="" id="uploadFilePath" />

    <!--Jquery 라이브러리 참조-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- 개발자 정의 클라이언트 스크립트 코드 -->
    <script>
      // 데이터 등록함수
      function fnSave() {
        // 백엔드 주소로 보낼 json데이터를 만든다.
        // ui 요소에서 사용자가 입력한 데이터로 서버로 전송할 json 데이터 구조의 속성에 데이터를 바인딩한다.

        let member = {
          memberId: $('#memberId').val(),
          pwd: $('#pwd').val(),
          nickName: $('#nickName').val(),

          // hidden 값으로 전달된 파일 저장경로를 전달해준다.
          profilePhoto: $('#uploadFilePath').val()
        };

        console.log('회원등록페이지에 입력된 데이터: ', member);

        // 백엔드 주소로 데이터를 보내 저장처리한다.
        $.post('http://localhost:3005/regist', member).done(function (response) {
          if (response.code == '200' || response.msg == 'OK') {
            alert('신규회원 등록완료');
            location.href = './list.html';
          } else {
            alert('회원가입 백엔드 호출에러발생');
            console.error('서버에러 코드내용: ', response.code, response.msg);
          }
        });
      }

      // 첨부파일이 선택되거나 변경되면 실행되는 이벤트
      $('#profilePhoto').change(function () {
        // alert("파일 선택 변경됨");

        // multer는 form 태그에서 사용이 가능한데, 폼 데이터로 전송해도 사용이 가능하다.
        // FormData 객체를 사용! 폼데이터를 생성하고 해당 폼 데이터내에 파일 데이터정보를 추가한다.
        // 해당 폼 데이터를 post 방식으로 백엔드 api에 전송한다.
        var data = new FormData();
        data.append('profilePhoto', $('input[name=profilePhoto]')[0].files[0]);

        $.ajax({
          data: data,
          type: 'post',
          url: 'http://localhost:3005/uploads',
          contentType: false,
          processData: false,
          success: function (res) {
            console.log('업로드된 파일의 경로정보: ', res);

            // input 히든 필드에 담아놓는다.
            $('#uploadFilePath').val(res.filepath);
          }
        });
      });
    </script>
  </body>
</html>
